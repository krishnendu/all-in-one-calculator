name: Deploy to GitHub Pages

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci
        
    - name: Generate PWA icons
      run: npm run generate-icons
        
    - name: Validate PWA files
      run: |
        echo "Validating PWA files..."
        if [ ! -f manifest.json ]; then
          echo "Error: manifest.json not found"
          exit 1
        fi
        if [ ! -f sw.js ]; then
          echo "Error: sw.js not found"
          exit 1
        fi
        if [ ! -f index.html ]; then
          echo "Error: index.html not found"
          exit 1
        fi
        if [ ! -f styles.css ]; then
          echo "Error: styles.css not found"
          exit 1
        fi
        if [ ! -f script.js ]; then
          echo "Error: script.js not found"
          exit 1
        fi
        echo "PWA files validated successfully"
        
    - name: Check PWA icons
      run: |
        echo "Checking PWA icons..."
        for size in 16 32 72 96 128 144 152 192 384 512; do
          if [ ! -f "icons/icon-${size}x${size}.webp" ]; then
            echo "Error: icon-${size}x${size}.webp not found"
            exit 1
          fi
        done
        echo "All PWA icons found"
        
    - name: Check screenshots
      run: |
        echo "Checking screenshots..."
        if [ ! -f "screenshots/desktop.webp" ]; then
          echo "Error: desktop.webp not found"
          exit 1
        fi
        if [ ! -f "screenshots/mobile.webp" ]; then
          echo "Error: mobile.webp not found"
          exit 1
        fi
        echo "All screenshots found"
        
    - name: Setup Pages
      uses: actions/configure-pages@v4
      
    - name: Upload artifact
      uses: actions/upload-pages-artifact@v3
      with:
        path: .
        
    - name: Deploy to GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v4
      
    - name: Show deployment info
      if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
      run: |
        echo "Deployment completed!"
        echo "Your PWA will be available at: https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}"
        echo "PWA features enabled:"
        echo "- Offline functionality"
        echo "- Install prompt"
        echo "- Service worker caching"
        echo "- Push notifications (if configured)"
        echo "- Perfect WebP icons with gradients"
        
    - name: Comment on PR
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: `## ðŸš€ PWA Calculator Ready for Review!
          
          This PR includes a fully functional Progressive Web App with:
          
          âœ… **PWA Features:**
          - Offline functionality
          - Install prompt
          - Service worker caching
          - Push notifications support
          - Perfect WebP icons with gradients
          
          âœ… **Calculator Features:**
          - Basic calculator
          - Scientific calculator
          - Investment comparison tool
          
          âœ… **Mobile Optimized:**
          - Responsive design
          - Touch-friendly interface
          - Mobile-first approach
          
          **Preview:** The app will be deployed to GitHub Pages once merged.
          
          **Install:** Users can install this as a native app on their devices!`
          })
